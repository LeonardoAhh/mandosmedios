rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Función helper para verificar si el usuario actual es RH
    function isRH() {
      return request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.rol == 'rh';
    }
    
    // =====================
    // USUARIOS
    // =====================
    match /users/{userId} {
      // Los usuarios pueden leer su propio perfil
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // RH puede leer todos los usuarios
      allow read: if isRH();
      
      // RH puede crear nuevos usuarios
      allow create: if isRH();
      
      // RH puede actualizar usuarios
      allow update: if isRH();
      
      // RH puede eliminar usuarios
      allow delete: if isRH();
      
      // Usuarios pueden actualizar su propio turnoActual
      allow update: if request.auth != null && 
        request.auth.uid == userId &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['turnoActual', 'lastLogin']);
    }
    
    // =====================
    // SUPERVISORES
    // =====================
    match /supervisores/{supervisorId} {
      // Todos los usuarios autenticados pueden leer supervisores
      allow read: if request.auth != null;
      
      // Solo RH puede modificar supervisores
      allow create, update, delete: if isRH();
    }
    
    // =====================
    // COMPETENCIAS (Preguntas)
    // =====================
    match /competencias/{competenciaId} {
      // Todos los usuarios autenticados pueden leer competencias
      allow read: if request.auth != null;
      
      // Solo RH puede modificar competencias
      allow create, update, delete: if isRH();
    }
    
    // =====================
    // ENCUESTAS
    // =====================
    match /surveys/{surveyId} {
      // Usuarios autenticados pueden leer encuestas
      allow read: if request.auth != null;
      
      // Solo RH puede crear/modificar encuestas
      allow create, update, delete: if isRH();
    }
    
    // =====================
    // RESPUESTAS (Evaluaciones)
    // =====================
    match /responses/{responseId} {
      // Cualquier usuario autenticado puede crear respuestas (anónimas)
      allow create: if request.auth != null;
      
      // Solo RH puede leer respuestas
      allow read: if isRH();
      
      // No se pueden modificar ni eliminar respuestas
      allow update, delete: if false;
    }
  }
}
